---
title: LobeHub åŠŸèƒ½å¼€å‘å®Œå…¨æŒ‡å—
description: äº†è§£å¦‚ä½•åœ¨ LobeHub ä¸­å¼€å‘å®Œæ•´çš„åŠŸèƒ½éœ€æ±‚ï¼Œæå‡å¼€å‘æ•ˆç‡ã€‚
tags:
  - LobeHub
  - åŠŸèƒ½å¼€å‘
  - å¼€å‘æŒ‡å—
  - å¼€åœºè®¾ç½®
---

# LobeHub åŠŸèƒ½å¼€å‘å®Œå…¨æŒ‡å—

æœ¬æ–‡æ¡£æ—¨åœ¨æŒ‡å¯¼å¼€å‘è€…äº†è§£å¦‚ä½•åœ¨ LobeHub ä¸­å¼€å‘ä¸€å—å®Œæ•´çš„åŠŸèƒ½éœ€æ±‚ã€‚

æˆ‘ä»¬å°†ä»¥ [RFC 021 - è‡ªå®šä¹‰åŠ©æ‰‹å¼€åœºå¼•å¯¼](https://github.com/lobehub/lobehub/discussions/891) ä¸ºä¾‹ï¼Œé˜è¿°å®Œæ•´çš„å®ç°æµç¨‹ã€‚

## ä¸€ã€æ›´æ–° Schema

LobeHub ä½¿ç”¨ PostgreSQL æ•°æ®åº“ï¼Œé¡¹ç›®ä½¿ç”¨ [Drizzle ORM](https://orm.drizzle.team/) æ¥æ“ä½œæ•°æ®åº“ã€‚

Schemas ç»Ÿä¸€æ”¾åœ¨ `packages/database/src/schemas/` ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦è°ƒæ•´ `agents` è¡¨å¢åŠ ä¸¤ä¸ªé…ç½®é¡¹å¯¹åº”çš„å­—æ®µï¼š

```diff
// packages/database/src/schemas/agent.ts
export const agents = pgTable(
  'agents',
  {
    id: text('id')
      .primaryKey()
      .$defaultFn(() => idGenerator('agents'))
      .notNull(),
    avatar: text('avatar'),
    backgroundColor: text('background_color'),
    plugins: jsonb('plugins').$type<string[]>().default([]),
    // ...
    tts: jsonb('tts').$type<LobeAgentTTSConfig>(),

+   openingMessage: text('opening_message'),
+   openingQuestions: text('opening_questions').array().default([]),

    ...timestamps,
  },
  (t) => ({
    // ...
    // !: update index here
  }),
);

```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ‰äº›æ—¶å€™æˆ‘ä»¬å¯èƒ½è¿˜éœ€è¦æ›´æ–°ç´¢å¼•ï¼Œä½†å¯¹äºè¿™ä¸ªéœ€æ±‚æˆ‘ä»¬æ²¡æœ‰ç›¸å…³çš„æ€§èƒ½ç“¶é¢ˆé—®é¢˜ï¼Œæ‰€ä»¥ä¸éœ€è¦æ›´æ–°ç´¢å¼•ã€‚

### æ•°æ®åº“è¿ç§»

è°ƒæ•´å®Œ schema åéœ€è¦ç”Ÿæˆå¹¶ä¼˜åŒ–è¿ç§»æ–‡ä»¶ï¼Œè¯¦ç»†æ­¥éª¤è¯·å‚é˜… [æ•°æ®åº“è¿ç§»æŒ‡å—](https://github.com/lobehub/lobe-chat/blob/main/.agents/skills/drizzle/references/db-migrations.md)ã€‚

## äºŒã€æ›´æ–°æ•°æ®æ¨¡å‹

æ•°æ®æ¨¡å‹å®šä¹‰åœ¨ `packages/types/src/` ä¸‹ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨ Drizzle schema å¯¼å‡ºçš„ç±»å‹ï¼ˆä¾‹å¦‚ `typeof agents.$inferInsert`ï¼‰ï¼Œè€Œæ˜¯æ ¹æ®å‰ç«¯éœ€æ±‚å®šä¹‰äº†ç‹¬ç«‹çš„æ•°æ®æ¨¡å‹ã€‚

æ›´æ–° `packages/types/src/agent/index.ts` ä¸­ `LobeAgentConfig` ç±»å‹ï¼š

```diff
export interface LobeAgentConfig {
  // ...
  chatConfig: LobeAgentChatConfig;
  /**
   * è§’è‰²æ‰€ä½¿ç”¨çš„è¯­è¨€æ¨¡å‹
   * @default gpt-4o-mini
   */
  model: string;

+  /**
+   * å¼€åœºç™½
+   */
+  openingMessage?: string;
+  /**
+   * å¼€åœºé—®é¢˜
+   */
+  openingQuestions?: string[];

  /**
   * è¯­è¨€æ¨¡å‹å‚æ•°
   */
  params: LLMParams;
  // ...
}
```

## ä¸‰ã€Service / Model å„å±‚å®ç°

é¡¹ç›®æŒ‰èŒè´£åˆ†ä¸ºå‰ç«¯å’Œåç«¯å¤šå±‚ï¼Œå®Œæ•´çš„åˆ†å±‚å¦‚ä¸‹ï¼š

```plaintext
+-------------------+--------------------------------------+------------------------------------------------------+
| Layer             | Location                             | Responsibility                                       |
+-------------------+--------------------------------------+------------------------------------------------------+
| Client Service    | src/services/                        | å°è£…å‰ç«¯å¯å¤ç”¨çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸€èˆ¬æ¶‰åŠå¤šä¸ªåç«¯è¯·æ±‚(tRPC)  |
| WebAPI            | src/app/(backend)/webapi/            | REST API ç«¯ç‚¹                                         |
| tRPC Router       | src/server/routers/                  | tRPC å…¥å£ï¼Œæ ¡éªŒè¾“å…¥ï¼Œè·¯ç”±åˆ° service                   |
| Server Service    | src/server/services/                 | æœåŠ¡ç«¯ä¸šåŠ¡é€»è¾‘ï¼Œå¯è®¿é—®æ•°æ®åº“                          |
| Server Module     | src/server/modules/                  | æœåŠ¡ç«¯æ¨¡å—ï¼Œä¸ç›´æ¥è®¿é—®æ•°æ®åº“                          |
| Repository        | packages/database/src/repositories/  | å°è£…å¤æ‚æŸ¥è¯¢ã€è·¨è¡¨æ“ä½œ                                |
| DB Model          | packages/database/src/models/        | å°è£…å•è¡¨çš„ CRUD æ“ä½œ                                  |
+-------------------+--------------------------------------+------------------------------------------------------+
```

**Client Service** æ˜¯å‰ç«¯ä»£ç ï¼Œå°è£…å¯å¤ç”¨çš„ä¸šåŠ¡é€»è¾‘ï¼Œé€šè¿‡ tRPC å®¢æˆ·ç«¯è°ƒç”¨åç«¯ã€‚ä¾‹å¦‚ `src/services/session/index.ts`ï¼š

```typescript
export class SessionService {
  updateSessionConfig = (id: string, config: PartialDeep<LobeAgentConfig>, signal?: AbortSignal) => {
    return lambdaClient.session.updateSessionConfig.mutate({ id, value: config }, { signal });
  };
}
```

**tRPC Router** æ˜¯åç«¯å…¥å£ï¼ˆ`src/server/routers/lambda/`ï¼‰ï¼Œæ ¡éªŒè¾“å…¥åè°ƒç”¨ Server Service å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼š

```typescript
export const sessionRouter = router({
  updateSessionConfig: sessionProcedure
    .input(
      z.object({
        id: z.string(),
        value: z.object({}).passthrough().partial(),
      }),
    )
    .mutation(async ({ input, ctx }) => {
      const session = await ctx.sessionModel.findByIdOrSlug(input.id);
      // ...
      const mergedValue = merge(session.agent, input.value);
      return ctx.sessionModel.updateConfig(session.agent.id, mergedValue);
    }),
});
```

å¯¹äºæœ¬æ¬¡éœ€æ±‚ï¼Œ`updateSessionConfig` åªæ˜¯ç®€å• merge configï¼Œå¹¶æ²¡æœ‰ç»†ç²’åº¦åˆ°å…·ä½“å­—æ®µï¼Œå› æ­¤å„å±‚éƒ½ä¸éœ€è¦ä¿®æ”¹ã€‚

## å››ã€å‰ç«¯å®ç°

### æ•°æ®æµ Store å®ç°

LobeHub ä½¿ç”¨ [zustand](https://zustand.docs.pmnd.rs/getting-started/introduction) ä½œä¸ºå…¨å±€çŠ¶æ€ç®¡ç†æ¡†æ¶ï¼Œå¯¹äºçŠ¶æ€ç®¡ç†çš„è¯¦ç»†å®è·µä»‹ç»ï¼Œå¯ä»¥æŸ¥é˜… [ğŸ“˜ çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ](/zh/docs/development/state-management/state-management-intro)ã€‚

å’Œ agent ç›¸å…³çš„ store æœ‰ä¸¤ä¸ªï¼š

- `src/features/AgentSetting/store` æœåŠ¡äº agent è®¾ç½®çš„å±€éƒ¨ store
- `src/store/agent` ç”¨äºè·å–å½“å‰ä¼šè¯ agent çš„ store

åè€…é€šè¿‡ `src/features/AgentSetting/AgentSettings.tsx` ä¸­ `AgentSettings` ç»„ä»¶çš„ `onConfigChange` ç›‘å¬å¹¶æ›´æ–°å½“å‰ä¼šè¯çš„ agent é…ç½®ã€‚

#### æ›´æ–° AgentSetting/store

é¦–å…ˆæˆ‘ä»¬æ›´æ–° initialStateï¼Œé˜…è¯» `src/features/AgentSetting/store/initialState.ts` åå¾—çŸ¥åˆå§‹ agent é…ç½®ä¿å­˜åœ¨ `src/const/settings/agent.ts` ä¸­çš„ `DEFAULT_AGENT_CONFIG`ï¼š

```diff
export const DEFAULT_AGENT_CONFIG: LobeAgentConfig = {
  chatConfig: DEFAULT_AGENT_CHAT_CONFIG,
  model: DEFAULT_MODEL,
+ openingQuestions: [],
  params: {
    frequency_penalty: 0,
    presence_penalty: 0,
    temperature: 1,
    top_p: 1,
  },
  plugins: [],
  provider: DEFAULT_PROVIDER,
  systemRole: '',
  tts: DEFAUTT_AGENT_TTS_CONFIG,
};
```

å…¶å®ä½ è¿™é‡Œä¸æ›´æ–°éƒ½å¯ä»¥ï¼Œå› ä¸º `openingQuestions` ç±»å‹æœ¬æ¥å°±æ˜¯å¯é€‰çš„ï¼Œ`openingMessage` æˆ‘è¿™é‡Œå°±ä¸æ›´æ–°äº†ã€‚

å› ä¸ºæˆ‘ä»¬å¢åŠ äº†ä¸¤ä¸ªæ–°å­—æ®µï¼Œä¸ºäº†æ–¹ä¾¿åœ¨ `src/features/AgentSetting/AgentOpening` æ–‡ä»¶å¤¹ä¸­ç»„ä»¶è®¿é—®å’Œæ€§èƒ½ä¼˜åŒ–ï¼Œæˆ‘ä»¬åœ¨ `src/features/AgentSetting/store/selectors.ts` å¢åŠ ç›¸å…³çš„ selectorsï¼š

```diff
+export const DEFAULT_OPENING_QUESTIONS: string[] = [];
export const selectors = {
  chatConfig,
+ openingMessage: (s: Store) => s.config.openingMessage,
+ openingQuestions: (s: Store) => s.config.openingQuestions || DEFAULT_OPENING_QUESTIONS,
};
```

è¿™é‡Œæˆ‘ä»¬å°±ä¸å¢åŠ é¢å¤–çš„ action ç”¨äºæ›´æ–° agent config äº†ï¼Œå› ä¸ºå·²æœ‰çš„ä»£ç ä¹Ÿæ˜¯ç›´æ¥ä½¿ç”¨ç»Ÿä¸€çš„ `setAgentConfig`ï¼š

```typescript
export const store: StateCreator<Store, [['zustand/devtools', never]]> = (set, get) => ({
  setAgentConfig: (config) => {
    get().dispatchConfig({ config, type: 'update' });
  },
});
```

#### æ›´æ–° store/agent

åœ¨å±•ç¤ºç»„ä»¶ä¸­æˆ‘ä»¬ä½¿ç”¨ `src/store/agent` è·å–å½“å‰ agent é…ç½®ï¼Œç®€å•åŠ ä¸¤ä¸ª selectorsï¼š

æ›´æ–° `src/store/agent/slices/chat/selectors/agent.ts`ï¼š

```diff
+const openingQuestions = (s: AgentStoreState) =>
+  currentAgentConfig(s).openingQuestions || DEFAULT_OPENING_QUESTIONS;
+const openingMessage = (s: AgentStoreState) => currentAgentConfig(s).openingMessage || '';

export const agentSelectors = {
  // ...
  isInboxSession,
+ openingMessage,
+ openingQuestions,
};
```

### i18n å¤„ç†

LobeHub æ˜¯å›½é™…åŒ–é¡¹ç›®ï¼Œä½¿ç”¨ [react-i18next](https://github.com/i18next/react-i18next) ä½œä¸º i18n æ¡†æ¶ã€‚æ–°å¢çš„ UI æ–‡æ¡ˆéœ€è¦ï¼š

1. åœ¨ `src/locales/default/` å¯¹åº”çš„ namespace æ–‡ä»¶ä¸­æ·»åŠ  keyï¼ˆé»˜è®¤è¯­è¨€ä¸ºè‹±æ–‡ï¼‰ï¼š

```typescript
// src/locales/default/setting.ts
export default {
  // ...
  'settingOpening.title': 'Opening Settings',
  'settingOpening.openingMessage.title': 'Opening Message',
  'settingOpening.openingMessage.placeholder': 'Enter a custom opening message...',
  'settingOpening.openingQuestions.title': 'Opening Questions',
  'settingOpening.openingQuestions.placeholder': 'Enter a guiding question',
  'settingOpening.openingQuestions.empty': 'No opening questions yet',
  'settingOpening.openingQuestions.repeat': 'Question already exists',
};
```

2. å¦‚æœæ–°å¢äº† namespaceï¼Œéœ€è¦åœ¨ `src/locales/default/index.ts` ä¸­å¯¼å‡º
3. å¼€å‘é¢„è§ˆæ—¶æ‰‹åŠ¨ç¿»è¯‘ `locales/zh-CN/` å’Œ `locales/en-US/` å¯¹åº”çš„ JSON æ–‡ä»¶
4. CI ä¼šè‡ªåŠ¨è¿è¡Œ `pnpm i18n` ç”Ÿæˆå…¶ä»–è¯­è¨€çš„ç¿»è¯‘

key çš„å‘½åè§„èŒƒä¸ºæ‰å¹³çš„ dot notationï¼š`{feature}.{context}.{action|status}`ã€‚

### UI å®ç°å’Œ action ç»‘å®š

æˆ‘ä»¬è¿™æ¬¡è¦æ–°å¢ä¸€ä¸ªç±»åˆ«çš„è®¾ç½®ã€‚åœ¨ `src/features/AgentSetting` ä¸­å®šä¹‰äº† agent çš„å„ç§è®¾ç½® UI ç»„ä»¶ï¼Œå¢åŠ ä¸€ä¸ªæ–‡ä»¶å¤¹ `AgentOpening` å­˜æ”¾å¼€åœºè®¾ç½®ç›¸å…³çš„ç»„ä»¶ã€‚

ä»¥å­ç»„ä»¶ `OpeningQuestions.tsx` ä¸ºä¾‹ï¼Œå±•ç¤ºå…³é”®é€»è¾‘ï¼ˆçœç•¥æ ·å¼ä»£ç ï¼‰ï¼š

```typescript
// src/features/AgentSetting/AgentOpening/OpeningQuestions.tsx
'use client';

import { memo, useCallback, useMemo, useState } from 'react';
import { useTranslation } from 'react-i18next';

import { useStore } from '../store';
import { selectors } from '../store/selectors';

const OpeningQuestions = memo(() => {
  const { t } = useTranslation('setting');
  const [questionInput, setQuestionInput] = useState('');

  // ä½¿ç”¨ selector è®¿é—®å¯¹åº”é…ç½®
  const openingQuestions = useStore(selectors.openingQuestions);
  // ä½¿ç”¨ action æ›´æ–°é…ç½®
  const updateConfig = useStore((s) => s.setAgentConfig);
  const setQuestions = useCallback(
    (questions: string[]) => {
      updateConfig({ openingQuestions: questions });
    },
    [updateConfig],
  );

  const addQuestion = useCallback(() => {
    if (!questionInput.trim()) return;
    setQuestions([...openingQuestions, questionInput.trim()]);
    setQuestionInput('');
  }, [openingQuestions, questionInput, setQuestions]);

  const removeQuestion = useCallback(
    (content: string) => {
      const newQuestions = [...openingQuestions];
      const index = newQuestions.indexOf(content);
      newQuestions.splice(index, 1);
      setQuestions(newQuestions);
    },
    [openingQuestions, setQuestions],
  );

  // æ¸²æŸ“ Input + SortableListï¼Œå…·ä½“ UI å‚è€ƒç»„ä»¶åº“æ–‡æ¡£
  // ...
});
```

å…³é”®ç‚¹ï¼š
- é€šè¿‡ `selectors` è¯»å– store ä¸­çš„é…ç½®
- é€šè¿‡ `setAgentConfig` action æ›´æ–°é…ç½®
- ä½¿ç”¨ `useTranslation('setting')` è·å– i18n æ–‡æ¡ˆ

åŒæ—¶æˆ‘ä»¬éœ€è¦å°†ç”¨æˆ·è®¾ç½®çš„å¼€åœºé…ç½®å±•ç¤ºå‡ºæ¥ï¼Œè¿™ä¸ªæ˜¯åœ¨ chat é¡µé¢ï¼Œå¯¹åº”ç»„ä»¶åœ¨ `src/app/[variants]/(main)/chat/(workspace)/@conversation/features/ChatList/WelcomeChatItem/WelcomeMessage.tsx`ï¼š

```typescript
const WelcomeMessage = () => {
  const { t } = useTranslation('chat');

  // ä» store/agent è·å–å½“å‰å¼€åœºé…ç½®
  const openingMessage = useAgentStore(agentSelectors.openingMessage);
  const openingQuestions = useAgentStore(agentSelectors.openingQuestions);

  const meta = useSessionStore(sessionMetaSelectors.currentAgentMeta, isEqual);

  const message = useMemo(() => {
    // ç”¨æˆ·è®¾ç½®äº†å°±ç”¨ç”¨æˆ·è®¾ç½®çš„
    if (openingMessage) return openingMessage;
    return !!meta.description ? agentSystemRoleMsg : agentMsg;
  }, [openingMessage, agentSystemRoleMsg, agentMsg, meta.description]);

  return openingQuestions.length > 0 ? (
    <Flexbox>
      <ChatItem avatar={meta} message={message} placement="left" />
      {/* æ¸²æŸ“å¼•å¯¼æ€§é—®é¢˜ */}
      <OpeningQuestions questions={openingQuestions} />
    </Flexbox>
  ) : (
    <ChatItem avatar={meta} message={message} placement="left" />
  );
};
```

## äº”ã€æµ‹è¯•

é¡¹ç›®ä½¿ç”¨ Vitest è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œç›¸å…³æŒ‡å—è¯¦è§ [æµ‹è¯•æŠ€èƒ½æ–‡æ¡£](https://github.com/lobehub/lobe-chat/blob/main/.agents/skills/testing/SKILL.md)ã€‚

**è¿è¡Œæµ‹è¯•ï¼š**

```bash
# è¿è¡ŒæŒ‡å®šæµ‹è¯•æ–‡ä»¶ï¼ˆä¸è¦è¿è¡Œ bun run testï¼Œå…¨é‡æµ‹è¯•è€—æ—¶å¾ˆé•¿ï¼‰
bunx vitest run --silent='passed-only' '[file-path]'

# database åŒ…çš„æµ‹è¯•
cd packages/database && bunx vitest run --silent='passed-only' '[file]'
```

**æ·»åŠ æ–°åŠŸèƒ½çš„æµ‹è¯•å»ºè®®ï¼š**

ç”±äºæˆ‘ä»¬ç›®å‰ä¸¤ä¸ªæ–°çš„é…ç½®å­—æ®µéƒ½æ˜¯å¯é€‰çš„ï¼Œç†è®ºä¸Šä¸æ›´æ–°æµ‹è¯•ä¹Ÿèƒ½è·‘é€šã€‚ä½†å¦‚æœä¿®æ”¹äº†é»˜è®¤é…ç½®ï¼ˆå¦‚ `DEFAULT_AGENT_CONFIG` å¢åŠ äº† `openingQuestions` å­—æ®µï¼‰ï¼Œå¯èƒ½å¯¼è‡´ä¸€äº›æµ‹è¯•å¿«ç…§ä¸åŒ¹é…ï¼Œéœ€è¦æ›´æ–°ã€‚

å»ºè®®å…ˆæœ¬åœ°è·‘ä¸‹ç›¸å…³æµ‹è¯•ï¼Œçœ‹å“ªäº›å¤±è´¥äº†å†é’ˆå¯¹æ€§æ›´æ–°ã€‚ä¾‹å¦‚ï¼š

```bash
bunx vitest run --silent='passed-only' 'src/store/agent/slices/chat/selectors/agent.test.ts'
```

å¦‚æœåªæ˜¯æƒ³ç¡®è®¤ç°æœ‰æµ‹è¯•æ˜¯å¦é€šè¿‡è€Œä¸æƒ³æœ¬åœ°è·‘ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æŸ¥çœ‹ GitHub Actions çš„æµ‹è¯•ç»“æœã€‚

**æ›´å¤šæµ‹è¯•åœºæ™¯æŒ‡å—ï¼š**

- DB Model æµ‹è¯•ï¼š`.agents/skills/testing/references/db-model-test.md`
- Zustand Store Action æµ‹è¯•ï¼š`.agents/skills/testing/references/zustand-store-action-test.md`
- Electron IPC æµ‹è¯•ï¼š`.agents/skills/testing/references/electron-ipc-test.md`

## æ€»ç»“

ä»¥ä¸Šå°±æ˜¯ LobeHub å¼€åœºè®¾ç½®åŠŸèƒ½çš„å®Œæ•´å®ç°æµç¨‹ï¼Œæ¶µç›–äº†ä»æ•°æ®åº“ schema â†’ æ•°æ®æ¨¡å‹ â†’ Service/Model â†’ Store â†’ i18n â†’ UI â†’ æµ‹è¯•çš„å…¨é“¾è·¯ã€‚å¼€å‘è€…å¯ä»¥å‚è€ƒæœ¬æ–‡æ¡£è¿›è¡Œç›¸å…³åŠŸèƒ½çš„å¼€å‘ã€‚
