---
title: åœ¨ LobeHub ä¸­é…ç½® Casdoor èº«ä»½éªŒè¯
description: å­¦ä¹ å¦‚ä½•åœ¨ LobeHub ä¸­é…ç½® Casdoor SSOï¼ŒåŒ…æ‹¬åˆ›å»ºåº”ç”¨å’Œè®¾ç½®ç¯å¢ƒå˜é‡ã€‚
tags:
  - Casdoor
  - èº«ä»½éªŒè¯
  - LobeHub
  - å•ç‚¹ç™»å½•
  - OIDC
---

# é…ç½® Casdoor èº«ä»½éªŒè¯

[Casdoor](https://casdoor.org/) æ˜¯ä¸€ä¸ªå¼€æºçš„èº«ä»½è®¿é—®ç®¡ç† (IAM) å¹³å°ï¼Œæä¾› Web UI æ”¯æŒå•ç‚¹ç™»å½•ã€‚

<Steps>
  ### åœ¨ Casdoor ä¸­åˆ›å»ºåº”ç”¨

  1. ç™»å½• Casdoor ç®¡ç†æ§åˆ¶å°
  2. å‰å¾€ **Applications**ï¼Œç‚¹å‡» **Add**
  3. é…ç½®åº”ç”¨ï¼š
     - Name: `LobeHub`
     - Organization: é€‰æ‹©ä½ çš„ç»„ç»‡
     - Redirect URLs: æ·»åŠ å›è°ƒ URL

  <Callout type={'info'}>
    **å›è°ƒ URL æ ¼å¼**: `https://your-domain.com/api/auth/callback/casdoor`
  </Callout>

  4. ä¿å­˜å¹¶è®°ä¸‹ **Client ID** å’Œ **Client Secret**

  ### è·å– Issuer URL

  Issuer URL æ˜¯ Casdoor æœåŠ¡å™¨ URLï¼Œé€šå¸¸ä¸ºï¼š`https://your-casdoor-domain`

  ### é…ç½®ç¯å¢ƒå˜é‡

  åœ¨éƒ¨ç½² LobeHub æ—¶ï¼Œä½ éœ€è¦é…ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

  | ç¯å¢ƒå˜é‡                     | ç±»å‹ | æè¿°                                                |
  | ------------------------ | -- | ------------------------------------------------- |
  | `AUTH_SECRET`            | å¿…é€‰ | ç”¨äºåŠ å¯†ä¼šè¯ä»¤ç‰Œçš„å¯†é’¥ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆï¼š`openssl rand -base64 32`    |
  | `AUTH_SSO_PROVIDERS`     | å¿…é€‰ | SSO æä¾›å•†ã€‚ä½¿ç”¨ Casdoor è¯·å¡«å†™ `casdoor`                  |
  | `AUTH_CASDOOR_ID`        | å¿…é€‰ | Casdoor åº”ç”¨çš„ Client ID                             |
  | `AUTH_CASDOOR_SECRET`    | å¿…é€‰ | Casdoor åº”ç”¨çš„ Client Secret                         |
  | `AUTH_CASDOOR_ISSUER`    | å¿…é€‰ | Casdoor æœåŠ¡å™¨ URLï¼ˆä¾‹å¦‚ `https://your-casdoor-domain`ï¼‰ |
  | `CASDOOR_WEBHOOK_SECRET` | å¯é€‰ | ç”¨äºéªŒè¯ Casdoor å‘é€çš„ Webhook è¯·æ±‚æ˜¯å¦åˆæ³•çš„å¯†é’¥                |

  <Callout type={'tip'}>
    å‰å¾€ [ğŸ“˜ ç¯å¢ƒå˜é‡](/zh/docs/self-hosting/environment-variables/auth#casdoor) å¯æŸ¥é˜…ç›¸å…³å˜é‡è¯¦æƒ…ã€‚
  </Callout>

  ### é…ç½® Webhookï¼ˆå¯é€‰ï¼‰

  > åœ¨ Casdoor `>=1.843.0` ä¸Šå¯ç”¨ã€‚

  é…ç½® Casdoor çš„ [Webhook](https://www.casdoor.org/docs/webhooks/overview#setting-up-a-webhook) ä»¥ä¾¿åœ¨ç”¨æˆ·ä¿¡æ¯æ›´æ–°æ—¶åŒæ­¥åˆ° LobeHubã€‚

  **åŒæ­¥çš„æ•°æ®å­—æ®µ**ï¼š

  - å¤´åƒ (`avatar`)
  - é‚®ç®± (`email`)
  - æ˜¾ç¤ºåç§° (`displayName`)

  **é…ç½®æ­¥éª¤**ï¼š

  1. å‰å¾€ `ç®¡ç†å·¥å…·` -> `Webhooks`ï¼Œåˆ›å»ºä¸€ä¸ª Webhook
  2. å¡«å†™ä»¥ä¸‹å­—æ®µï¼š
     - é“¾æ¥ï¼š`https://your-domain.com/api/webhooks/casdoor`
     - æ–¹æ³•ï¼š`POST`
     - å†…å®¹ç±»å‹ï¼š`application/json`
     - åè®®å¤´ï¼š`casdoor-secret`: `ä½ çš„Webhookå¯†é’¥`
     - äº‹ä»¶ï¼š`update-user`
  3. å¯†é’¥å¯å‰å¾€ [generate-secret.vercel.app/10](https://generate-secret.vercel.app/10) ç”Ÿæˆ
  4. å°†å¯†é’¥å¡«å†™åˆ°ç¯å¢ƒå˜é‡ `CASDOOR_WEBHOOK_SECRET`
</Steps>

<Callout type={'info'}>éƒ¨ç½²æˆåŠŸåï¼Œç”¨æˆ·å°†å¯ä»¥é€šè¿‡ Casdoor èº«ä»½è®¤è¯å¹¶ä½¿ç”¨ LobeHubã€‚</Callout>

## Docker Compose éƒ¨ç½² Casdoor

å¦‚æœä½ ä½¿ç”¨ Docker Compose éƒ¨ç½² LobeHubï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹é…ç½®æ¥é›†æˆ Casdoor ä½œä¸ºé‰´æƒæœåŠ¡ã€‚

### åå‘ä»£ç†é…ç½®

åœ¨åŸŸåæ¨¡å¼ä¸­ï¼Œä½ éœ€è¦å®Œæˆåå‘ä»£ç†é…ç½®ï¼Œå¹¶ç¡®ä¿å±€åŸŸç½‘ / å…¬ç½‘èƒ½è®¿é—®åˆ° Casdoor æœåŠ¡ï¼š

| åŸŸå                 | åä»£ç«¯å£   | è¯´æ˜         |
| ------------------ | ------ | ---------- |
| `auth.example.com` | `8000` | Casdoor æœåŠ¡ |

<Callout type="important">
  å¦‚æœä½ ä½¿ç”¨å¦‚ [å®å¡”é¢æ¿](https://www.bt.cn/) ç­‰é¢æ¿è½¯ä»¶è¿›è¡Œåå‘ä»£ç†é…ç½®ï¼Œ
  ä½ éœ€è¦ç¡®ä¿å…¶å¯¹ `.well-known` è·¯å¾„çš„è¯·æ±‚ä¸è¿›è¡Œæ‹¦æˆªï¼Œä»¥ç¡®ä¿ Casdoor çš„ OAuth2 é…ç½®èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚
  è¿™é‡Œæä¾›ä¸€ä»½é’ˆå¯¹ Casdoor æœåŠ¡çš„ Nginx server å—çš„è·¯å¾„ç™½åå•é…ç½®ï¼š

  ```nginx
  location /.well-known/openid-configuration {
    proxy_pass http://localhost:8000;  # è½¬å‘åˆ° localhost:8000
    proxy_set_header Host $host;  # ä¿ç•™åŸå§‹ä¸»æœºå¤´
    proxy_set_header X-Real-IP $remote_addr;  # ä¿ç•™å®¢æˆ·ç«¯çœŸå®IP
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # ä¿ç•™è½¬å‘çš„IP
    proxy_set_header X-Forwarded-Proto $scheme;  # ä¿ç•™è¯·æ±‚åè®®
  }
  ```

  âš ï¸ è¯·ä¸è¦åœ¨æ­¤ç±»é¢æ¿è½¯ä»¶çš„åå‘ä»£ç†è®¾ç½®ä¸­å¼€å¯ä»»ä½•å½¢å¼çš„ç¼“å­˜ï¼Œä»¥å…å½±å“æœåŠ¡çš„æ­£å¸¸è¿è¡Œã€‚
  è¯¦æƒ…è¯·è§ [https://github.com/lobehub/lobe-chat/discussions/5986](https://github.com/lobehub/lobe-chat/discussions/5986)
</Callout>

### å¿…è¦é…ç½®

1. LobeHub éœ€è¦ä¸ Casdoor é€šè®¯ï¼Œå› æ­¤ä½ éœ€è¦é…ç½® Casdoor çš„ Issuerï¼š

```env
AUTH_CASDOOR_ISSUER=https://auth.example.com
```

è¯¥é…ç½®ä¼šå½±å“ LobeHub çš„ç™»å½•é‰´æƒæœåŠ¡ï¼Œä½ éœ€è¦ç¡®ä¿ Casdoor æœåŠ¡çš„åœ°å€æ­£ç¡®ã€‚

2. åœ¨ Casdoor ä¸­å…è®¸å›è°ƒåœ°å€ä¸º LobeHub çš„åœ°å€ï¼š

è¯·åœ¨ Casdoor çš„ Web é¢æ¿çš„ `èº«ä»½è®¤è¯ -> åº”ç”¨` -> `<åº”ç”¨IDï¼Œé»˜è®¤ä¸º app-built-in>` -> `é‡å®šå‘URL` ä¸­æ·»åŠ ä¸€è¡Œï¼š

```
https://lobe.example.com/api/auth/callback/casdoor
```

3. Casdoor éœ€è¦åœ¨ç¯å¢ƒå˜é‡ä¸­æä¾›è®¿é—®çš„ Origin ä¿¡æ¯ï¼š

```env
origin=https://auth.example.com
```

### ä½¿ç”¨ MinIO å­˜å‚¨ Casdoor å¤´åƒ

å…è®¸ç”¨æˆ·åœ¨ Casdoor ä¸­æ›´æ¢å¤´åƒï¼š

1. ä½ éœ€è¦é¦–å…ˆåœ¨ `buckets` ä¸­åˆ›å»ºä¸€ä¸ªåä¸º `casdoor` çš„æ¡¶ï¼Œé€‰æ‹©è‡ªå®šä¹‰ç­–ç•¥ï¼Œå¤åˆ¶å¹¶ç²˜è´´å¦‚ä¸‹å†…å®¹ï¼š

   ```json
   {
     "Statement": [
       {
         "Effect": "Allow",
         "Principal": {
           "AWS": ["*"]
         },
         "Action": ["s3:GetBucketLocation"],
         "Resource": ["arn:aws:s3:::casdoor"]
       },
       {
         "Effect": "Allow",
         "Principal": {
           "AWS": ["*"]
         },
         "Action": ["s3:ListBucket"],
         "Resource": ["arn:aws:s3:::casdoor"],
         "Condition": {
           "StringEquals": {
             "s3:prefix": ["files/*"]
           }
         }
       },
       {
         "Effect": "Allow",
         "Principal": {
           "AWS": ["*"]
         },
         "Action": ["s3:PutObject", "s3:DeleteObject", "s3:GetObject"],
         "Resource": ["arn:aws:s3:::casdoor/**"]
       }
     ],
     "Version": "2012-10-17"
   }
   ```

2. åˆ›å»ºä¸€ä¸ªæ–°çš„è®¿é—®å¯†é’¥ï¼Œå°†ç”Ÿæˆçš„ `Access Key` å’Œ `Secret Key` å­˜å‚¨ä¹‹

3. åœ¨ Casdoor çš„ `èº«ä»½è®¤è¯ -> æä¾›å•†` ä¸­å…³è” MinIO S3 æœåŠ¡ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹é…ç½®ï¼š

   ![casdoor](/blog/assets18bb134dbc5792d6a624199cca8bf7d3.webp)

   å…¶ä¸­ï¼Œå®¢æˆ·ç«¯ IDã€å®¢æˆ·ç«¯å¯†é’¥ä¸ºä¸Šä¸€æ­¥åˆ›å»ºçš„è®¿é—®å¯†é’¥ä¸­çš„ `Access Key` å’Œ `Secret Key`ï¼Œ`192.168.31.251` åº”å½“è¢«æ›¿æ¢ä¸º `your_server_ip`ã€‚

4. åœ¨ Casdoor çš„ `èº«ä»½è®¤è¯ -> åº”ç”¨` ä¸­ï¼Œå¯¹ `app-built-in` åº”ç”¨æ·»åŠ æä¾›å•†ï¼Œé€‰æ‹© `minio`ï¼Œä¿å­˜å¹¶é€€å‡º

5. ä½ å¯ä»¥åœ¨ Casdoor çš„ `èº«ä»½è®¤è¯ -> èµ„æº` ä¸­ï¼Œå°è¯•ä¸Šä¼ æ–‡ä»¶ä»¥æµ‹è¯•é…ç½®æ˜¯å¦æ­£ç¡®

### å¸¸è§é—®é¢˜

#### æ— æ³•æ­£å¸¸ç™»é™†

è¯·æ ¹æ®å®¹å™¨æ—¥å¿—æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä»¥ä¸‹é”™è¯¯ï¼š

```sh
docker logs -f lobe-chat
```

**r3: "response" is not a conform Authorization Server Metadata response**

```log
lobe-chat      | [auth][error] r3: "response" is not a conform Authorization Server Metadata response (unexpected HTTP status code)
```

æˆå› ï¼šè¯¥é—®é¢˜ä¸€èˆ¬æ˜¯ç”±äºä½ çš„åå‘ä»£ç†é…ç½®ä¸æ­£ç¡®å¯¼è‡´çš„ï¼Œä½ éœ€è¦ç¡®ä¿ä½ çš„åå‘ä»£ç†é…ç½®ä¸ä¼šæ‹¦æˆª Casdoor çš„ OAuth2 é…ç½®è¯·æ±‚ã€‚

è§£å†³æ–¹æ¡ˆï¼š

- è¯·å‚è€ƒä¸Šæ–¹çš„åå‘ä»£ç†é…ç½®æ³¨æ„äº‹é¡¹ã€‚

- ä¸€ä¸ªç›´æ¥çš„æ’æŸ¥æ–¹å¼ï¼Œä½ å¯ä»¥ç›´æ¥è®¿é—® `https://auth.example.com/.well-known/openid-configuration`ï¼Œå¦‚æœï¼š
  - è¿”å›äº†é JSON æ ¼å¼çš„æ•°æ®ï¼Œåˆ™è¯´æ˜ä½ çš„åå‘ä»£ç†é…ç½®é”™è¯¯ã€‚
  - å¦‚æœè¿”å›çš„ JSON æ ¼å¼æ•°æ®ä¸­çš„ `"issuer": "URL"` å­—æ®µä¸æ˜¯ä½ é…ç½®çš„ `https://auth.example.com`ï¼Œåˆ™è¯´æ˜ä½ çš„ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯ã€‚

**TypeError: fetch failed**

```log
lobe-chat      | [auth][error] TypeError: fetch failed
```

æˆå› ï¼šLobeHub æ— æ³•è®¿é—®é‰´æƒæœåŠ¡ã€‚

è§£å†³æ–¹æ¡ˆï¼š

- è¯·æ£€æŸ¥ä½ çš„é‰´æƒæœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œä»¥åŠ LobeHub æ‰€åœ¨çš„ç½‘ç»œæ˜¯å¦èƒ½å¤Ÿè®¿é—®åˆ°é‰´æƒæœåŠ¡ã€‚

- ä¸€ä¸ªç›´æ¥çš„æ’æŸ¥æ–¹å¼ï¼Œä½ å¯ä»¥åœ¨ LobeHub å®¹å™¨çš„ç»ˆç«¯ä¸­ï¼Œä½¿ç”¨ `curl` å‘½ä»¤è®¿é—®ä½ çš„é‰´æƒæœåŠ¡ `https://auth.example.com/.well-known/openid-configuration`ï¼Œå¦‚æœè¿”å›äº† JSON æ ¼å¼çš„æ•°æ®ï¼Œåˆ™è¯´æ˜ä½ çš„é‰´æƒæœåŠ¡æ­£å¸¸è¿è¡Œã€‚

#### åå‘ä»£ç†ä¸‹ OAuth ä»¤ç‰Œäº¤æ¢å¤±è´¥

å¦‚æœåœ¨åå‘ä»£ç†åä½¿ç”¨ Docker æ—¶ OAuth è®¤è¯åœ¨ä»¤ç‰Œäº¤æ¢é˜¶æ®µå¤±è´¥ï¼Œè¿™é€šå¸¸æ˜¯ç”±é»˜è®¤çš„ `MIDDLEWARE_REWRITE_THROUGH_LOCAL=1` è®¾ç½®å¼•èµ·çš„ï¼Œè¯¥è®¾ç½®ä¼šå°† URL é‡å†™ä¸º `127.0.0.1:3210`ã€‚

**è§£å†³æ–¹æ¡ˆ**: åœ¨ `.env` æ–‡ä»¶ä¸­è®¾ç½® `MIDDLEWARE_REWRITE_THROUGH_LOCAL=0` å¹¶é‡å¯ Docker å®¹å™¨ï¼š

```bash
docker compose down
docker compose up -d
```

### Docker Compose é…ç½®æ–‡ä»¶

Casdoor çš„ Docker Compose é…ç½®æ–‡ä»¶å¯ä»¥åœ¨ [docker-compose/local/casdoor](https://github.com/lobehub/lobe-chat/tree/main/docker-compose/local/casdoor) ç›®å½•ä¸­æ‰¾åˆ°ã€‚

## ç›¸å…³èµ„æº

- [Casdoor æ–‡æ¡£](https://casdoor.org/docs/overview)
- [Casdoor åº”ç”¨é…ç½®](https://casdoor.org/docs/application/config)
