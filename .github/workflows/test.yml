name: Test CI

on: [push, pull_request]

permissions:
  actions: write
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Check for duplicate runs
  pre_job:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v5
        with:
          concurrent_skipping: "same_content_newer"
          skip_after_successful_duplicate: "true"
          do_not_skip: '["workflow_dispatch", "schedule"]'

  # Package tests - all packages in single job to save runner resources
  test-packages:
    needs: pre_job
    if: needs.pre_job.outputs.should_skip != 'true'
    runs-on: ubuntu-latest
    name: Test Packages
    env:
      PACKAGES: "@lobechat/file-loaders @lobechat/prompts @lobechat/model-runtime @lobechat/web-crawler @lobechat/electron-server-ipc @lobechat/utils @lobechat/python-interpreter @lobechat/context-engine @lobechat/agent-runtime @lobechat/conversation-flow @lobechat/ssrf-safe-fetch @lobechat/memory-user-memory model-bank"

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24.11.1
          package-manager-cache: false

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ secrets.BUN_VERSION }}

      - name: Install deps
        run: bun i

      - name: Test packages with coverage
        run: |
          for package in $PACKAGES; do
            echo "::group::Testing $package"
            bun run --filter $package test:coverage
            echo "::endgroup::"
          done

      - name: Upload coverage to Codecov
        if: always()
        run: |
          for package in $PACKAGES; do
            # Extract directory name: @lobechat/file-loaders -> file-loaders, model-bank -> model-bank
            dir="${package#@lobechat/}"
            if [ -f "./packages/$dir/coverage/lcov.info" ]; then
              echo "Uploading coverage for $package..."
              npx codecov --token=${{ secrets.CODECOV_TOKEN }} \
                --file=./packages/$dir/coverage/lcov.info \
                --flags=packages/$dir
            fi
          done

  # App tests
  test-website:
    needs: pre_job
    if: needs.pre_job.outputs.should_skip != 'true'
    name: Test Website

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24.11.1
          package-manager-cache: false

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install deps
        run: bun i

      - name: Test App Coverage
        run: bun run test-app:coverage

      - name: Upload App Coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/app/lcov.info
          flags: app

  test-desktop:
    needs: pre_job
    if: needs.pre_job.outputs.should_skip != 'true'
    name: Test Desktop App

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24.11.1
          package-manager-cache: false

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install deps
        run: pnpm install
        working-directory: apps/desktop
        env:
          NODE_OPTIONS: --max-old-space-size=8192

      - name: Typecheck Desktop
        run: pnpm type-check
        working-directory: apps/desktop

      - name: Test Desktop Client
        run: pnpm test
        working-directory: apps/desktop

      - name: Upload Desktop App Coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./apps/desktop/coverage/lcov.info
          flags: desktop

  test-databsae:
    needs: pre_job
    if: needs.pre_job.outputs.should_skip != 'true'
    name: Test Database

    runs-on: ubuntu-latest

    services:
      postgres:
        image: paradedb/paradedb:latest
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s  --health-retries 5

        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24.11.1
          package-manager-cache: false

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Install deps
        run: pnpm i

      - name: Lint
        run: npm run lint

      - name: Test Client DB
        run: pnpm --filter @lobechat/database test:client-db
        env:
          KEY_VAULTS_SECRET: Kix2wcUONd4CX51E/ZPAd36BqM4wzJgKjPtz2sGztqQ=
          S3_PUBLIC_DOMAIN: https://example.com
          APP_URL: https://home.com

      - name: Test Coverage
        run: pnpm --filter @lobechat/database test:coverage
        env:
          DATABASE_TEST_URL: postgresql://postgres:postgres@localhost:5432/postgres
          DATABASE_DRIVER: node
          KEY_VAULTS_SECRET: Kix2wcUONd4CX51E/ZPAd36BqM4wzJgKjPtz2sGztqQ=
          S3_PUBLIC_DOMAIN: https://example.com
          APP_URL: https://home.com

      - name: Upload Database coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./packages/database/coverage/lcov.info
          flags: database
