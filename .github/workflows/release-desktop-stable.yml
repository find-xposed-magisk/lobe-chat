name: Release Desktop Stable

# ============================================
# Stable é¢‘é“å‘ç‰ˆå·¥ä½œæµ
# ============================================
# è§¦å‘æ¡ä»¶: å‘å¸ƒä¸å« pre-release åŽç¼€çš„ release (å¦‚ v2.0.0)
#
# ä¸Ž Beta çš„åŒºåˆ«:
#   1. ä»…å“åº” stable ç‰ˆæœ¬ tag (ä¸å«ä»»ä½• '-' åŽç¼€)
#   2. ä½¿ç”¨ STABLE ä¸“ç”¨çš„ Umami é…ç½®
#   3. é¢å¤–ä¸Šä¼ åˆ° S3 æ›´æ–°æœåŠ¡å™¨
#   4. æž„å»ºæ—¶æ³¨å…¥ UPDATE_SERVER_URL è®©å®¢æˆ·ç«¯ä»Ž S3 æ£€æŸ¥æ›´æ–°
#
# éœ€è¦é…ç½®çš„ Secrets (S3 ç›¸å…³, ç»Ÿä¸€ UPDATE_ å‰ç¼€):
#   - UPDATE_AWS_ACCESS_KEY_ID
#   - UPDATE_AWS_SECRET_ACCESS_KEY
#   - UPDATE_S3_BUCKET (S3 å­˜å‚¨æ¡¶åç§°)
#   - UPDATE_S3_REGION (å¯é€‰, é»˜è®¤ us-east-1)
#   - UPDATE_S3_ENDPOINT (å¯é€‰, ç”¨äºŽ R2/MinIO ç­‰ S3 å…¼å®¹æœåŠ¡)
#   - UPDATE_SERVER_URL (å®¢æˆ·ç«¯æ£€æŸ¥æ›´æ–°çš„ URL)
# ============================================

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 2.0.0)'
        required: true
        type: string
      build_mac:
        description: 'Build macOS (ARM64)'
        required: false
        type: boolean
        default: true
      build_mac_intel:
        description: 'Build macOS (Intel x64)'
        required: false
        type: boolean
        default: true
      build_windows:
        description: 'Build Windows'
        required: false
        type: boolean
        default: true
      build_linux:
        description: 'Build Linux'
        required: false
        type: boolean
        default: true
      skip_s3_upload:
        description: 'Skip S3 upload (for testing)'
        required: false
        type: boolean
        default: true
      skip_github_release:
        description: 'Skip GitHub release upload (for testing)'
        required: false
        type: boolean
        default: true

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

permissions: read-all

env:
  NODE_VERSION: '24.11.1'

jobs:
  # ============================================
  # æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯
  # ============================================
  check-stable:
    name: Check Release Version
    runs-on: ubuntu-latest
    outputs:
      is_stable: ${{ steps.check.outputs.is_stable }}
      version: ${{ steps.check.outputs.version }}
      is_manual: ${{ steps.check.outputs.is_manual }}
      release_notes: ${{ steps.check.outputs.release_notes }}
    steps:
      - name: Check release info
        id: check
        run: |
          # åˆ¤æ–­è§¦å‘æ–¹å¼
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘: ä½¿ç”¨è¾“å…¥çš„ç‰ˆæœ¬å·
            version="${{ inputs.version }}"
            version="${version#v}"
            echo "is_manual=true" >> $GITHUB_OUTPUT
            echo "version=${version}" >> $GITHUB_OUTPUT
            echo "release_notes=" >> $GITHUB_OUTPUT
            echo "ðŸ”§ Manual trigger: version=${version}"
          else
            # Release è§¦å‘: ä»Ž tag æå–ç‰ˆæœ¬å·
            version="${{ github.event.release.tag_name }}"
            version="${version#v}"
            echo "is_manual=false" >> $GITHUB_OUTPUT
            echo "version=${version}" >> $GITHUB_OUTPUT
            release_body="${{ github.event.release.body }}"
            {
              echo "release_notes<<EOF"
              printf '%s\n' "$release_body"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          fi

          # æ£€æŸ¥æ˜¯å¦ä¸º stable ç‰ˆæœ¬ (ä¸å«ä»»ä½• '-' åŽç¼€)
          if [[ "$version" == *"-"* ]]; then
            echo "is_stable=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Skipping: $version is not a stable release"
          else
            echo "is_stable=true" >> $GITHUB_OUTPUT
            echo "âœ… Stable release detected: $version"
          fi

  # ============================================
  # é…ç½®æž„å»ºçŸ©é˜µ (æ£€æŸ¥è‡ªæ‰˜ç®¡ Runner)
  # ============================================
  configure-build:
    needs: [check-stable]
    if: needs.check-stable.outputs.is_stable == 'true'
    name: Configure Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Generate Matrix
        id: set-matrix
        run: |
          # åŸºç¡€çŸ©é˜µ
          static_matrix='[]'

          # Windows
          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]] || [[ "${{ inputs.build_windows }}" == "true" ]]; then
            static_matrix=$(echo "$static_matrix" | jq -c '. + [{"os": "windows-2025", "name": "windows-2025"}]')
          fi

          # Linux
          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]] || [[ "${{ inputs.build_linux }}" == "true" ]]; then
            static_matrix=$(echo "$static_matrix" | jq -c '. + [{"os": "ubuntu-latest", "name": "ubuntu-latest"}]')
          fi

          # macOS (ARM64)
          # ä½¿ç”¨ GitHub Hosted Runner (macos-15 ä¿®å¤ hdiutil é—®é¢˜)
          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]] || [[ "${{ inputs.build_mac }}" == "true" ]]; then
            echo "Using GitHub-Hosted Runner for macOS ARM64"
            arm_entry='{"os": "macos-15", "name": "macos-arm64"}'
            static_matrix=$(echo "$static_matrix" | jq -c --argjson entry "$arm_entry" '. + [$entry]')
          fi

          if [[ "${{ github.event_name }}" != "workflow_dispatch" ]] || [[ "${{ inputs.build_mac_intel }}" == "true" ]]; then
            echo "Using GitHub-Hosted Runner for macOS Intel x64"
            intel_entry='{"os": "macos-15-intel", "name": "macos-intel"}'
            static_matrix=$(echo "$static_matrix" | jq -c --argjson entry "$intel_entry" '. + [$entry]')
          fi

          # è¾“å‡º
          echo "matrix={\"include\":$static_matrix}" >> $GITHUB_OUTPUT

  # ============================================
  # å¤šå¹³å°æž„å»º
  # ============================================
  build:
    needs: [check-stable, configure-build]
    if: needs.check-stable.outputs.is_stable == 'true'
    name: Build Desktop App
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.configure-build.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup build environment
        uses: ./.github/actions/desktop-build-setup
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Set package version
        run: npm run workflow:set-desktop-version ${{ needs.check-stable.outputs.version }} stable

      # macOS æž„å»ºå‰æ¸…ç† (ä¿®å¤ hdiutil é—®é¢˜ https://github.com/electron-userland/electron-builder/issues/8415)
      - name: Clean previous build artifacts (macOS)
        if: runner.os == 'macOS'
        run: |
          sudo rm -rf apps/desktop/release || true
          sudo rm -rf apps/desktop/dist || true
          sudo rm -rf /tmp/electron-builder* || true

      # macOS æž„å»º
      - name: Build artifact on macOS
        if: runner.os == 'macOS'
        run: npm run desktop:package:app
        env:
          UPDATE_CHANNEL: stable
          UPDATE_SERVER_URL: ${{ secrets.UPDATE_SERVER_URL }}
          RELEASE_NOTES: ${{ needs.check-stable.outputs.release_notes }}
          APP_URL: http://localhost:3015
          DATABASE_URL: 'postgresql://postgres@localhost:5432/postgres'
          KEY_VAULTS_SECRET: 'oLXWIiR/AKF+rWaqy9lHkrYgzpATbW3CtJp3UfkVgpE='
          CSC_LINK: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CSC_KEY_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          CSC_FOR_PULL_REQUEST: true
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          NEXT_PUBLIC_DESKTOP_PROJECT_ID: ${{ secrets.UMAMI_STABLE_DESKTOP_PROJECT_ID }}
          NEXT_PUBLIC_DESKTOP_UMAMI_BASE_URL: ${{ secrets.UMAMI_STABLE_DESKTOP_BASE_URL }}
          # Debug hdiutil issues (https://github.com/electron-userland/electron-builder/issues/8415)
          DEBUG_DMG: true

      # Windows æž„å»º
      - name: Build artifact on Windows
        if: runner.os == 'Windows'
        run: npm run desktop:package:app
        env:
          UPDATE_CHANNEL: stable
          UPDATE_SERVER_URL: ${{ secrets.UPDATE_SERVER_URL }}
          RELEASE_NOTES: ${{ needs.check-stable.outputs.release_notes }}
          APP_URL: http://localhost:3015
          DATABASE_URL: 'postgresql://postgres@localhost:5432/postgres'
          KEY_VAULTS_SECRET: 'oLXWIiR/AKF+rWaqy9lHkrYgzpATbW3CtJp3UfkVgpE='
          NEXT_PUBLIC_DESKTOP_PROJECT_ID: ${{ secrets.UMAMI_STABLE_DESKTOP_PROJECT_ID }}
          NEXT_PUBLIC_DESKTOP_UMAMI_BASE_URL: ${{ secrets.UMAMI_STABLE_DESKTOP_BASE_URL }}
          TEMP: C:\temp
          TMP: C:\temp

      # Linux æž„å»º
      - name: Build artifact on Linux
        if: runner.os == 'Linux'
        run: |
          npm run desktop:package:app
          tar -czf apps/desktop/release/lobehub-renderer.tar.gz -C out .
        env:
          UPDATE_CHANNEL: stable
          UPDATE_SERVER_URL: ${{ secrets.UPDATE_SERVER_URL }}
          RELEASE_NOTES: ${{ needs.check-stable.outputs.release_notes }}
          APP_URL: http://localhost:3015
          DATABASE_URL: 'postgresql://postgres@localhost:5432/postgres'
          KEY_VAULTS_SECRET: 'oLXWIiR/AKF+rWaqy9lHkrYgzpATbW3CtJp3UfkVgpE='
          NEXT_PUBLIC_DESKTOP_PROJECT_ID: ${{ secrets.UMAMI_STABLE_DESKTOP_PROJECT_ID }}
          NEXT_PUBLIC_DESKTOP_UMAMI_BASE_URL: ${{ secrets.UMAMI_STABLE_DESKTOP_BASE_URL }}

      - name: Upload artifacts
        uses: ./.github/actions/desktop-upload-artifacts
        with:
          artifact-name: release-${{ matrix.name }}

  # ============================================
  # åˆå¹¶ macOS å¤šæž¶æž„æ–‡ä»¶
  # ============================================
  merge-mac-files:
    needs: [build, check-stable]
    name: Merge macOS Release Files
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          package-manager-cache: false

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: release
          pattern: release-*
          merge-multiple: true

      - name: List downloaded artifacts
        run: ls -R release

      - name: Install yaml only for merge step
        run: |
          cd scripts/electronWorkflow
          if [ ! -f package.json ]; then
            echo '{"name":"merge-mac-release","private":true}' > package.json
          fi
          bun add --no-save yaml@2.8.1

      - name: Merge latest-mac.yml files
        run: bun run scripts/electronWorkflow/mergeMacReleaseFiles.js

      - name: Upload artifacts with merged macOS files
        uses: actions/upload-artifact@v6
        with:
          name: merged-release
          path: release/
          retention-days: 1

  # ============================================
  # å‘å¸ƒåˆ° GitHub Releases
  # ============================================
  publish-github:
    needs: [merge-mac-files, check-stable]
    name: Publish to GitHub Release
    runs-on: ubuntu-latest
    # æ‰‹åŠ¨è§¦å‘æ—¶å¯é€‰æ‹©è·³è¿‡
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_github_release) }}
    permissions:
      contents: write
    steps:
      - name: Download merged artifacts
        uses: actions/download-artifact@v7
        with:
          name: merged-release
          path: release

      - name: List final artifacts
        run: ls -R release

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥çš„ç‰ˆæœ¬å·åˆ›å»º tag
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('v{0}', needs.check-stable.outputs.version) || github.event.release.tag_name }}
          # æ‰‹åŠ¨è§¦å‘æ—¶åˆ›å»ºä¸º draft
          draft: ${{ github.event_name == 'workflow_dispatch' }}
          files: |
            release/stable*
            release/latest*
            release/*.dmg*
            release/*.zip*
            release/*.exe*
            release/*.AppImage
            release/*.deb*
            release/*.snap*
            release/*.rpm*
            release/*.tar.gz*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # å‘å¸ƒåˆ° S3 æ›´æ–°æœåŠ¡å™¨
  # ============================================
  # S3 ç›®å½•ç»“æž„:
  #   s3://bucket/
  #     stable/
  #       stable-mac.yml      â† electron-updater æ£€æŸ¥æ›´æ–° (stable channel)
  #       stable.yml          â† Windows (stable channel)
  #       stable-linux.yml    â† Linux (stable channel)
  #       latest-mac.yml      â† fallback for GitHub provider
  #       {version}/          â† ç‰ˆæœ¬ç›®å½•
  #         *.dmg, *.zip, *.exe, ...
  # ============================================
  publish-s3:
    needs: [merge-mac-files, check-stable]
    name: Publish to S3
    runs-on: ubuntu-latest
    # æ‰‹åŠ¨è§¦å‘æ—¶å¯é€‰æ‹©è·³è¿‡
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_s3_upload) }}
    steps:
      - name: Download merged artifacts
        uses: actions/download-artifact@v7
        with:
          name: merged-release
          path: release

      - name: List artifacts to upload
        run: |
          echo "ðŸ“¦ Artifacts to upload to S3:"
          ls -lah release/
          echo ""
          echo "ðŸ“‹ Version: ${{ needs.check-stable.outputs.version }}"

      - name: Upload to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.UPDATE_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.UPDATE_AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.UPDATE_S3_REGION || 'us-east-1' }}
          S3_BUCKET: ${{ secrets.UPDATE_S3_BUCKET }}
          S3_ENDPOINT: ${{ secrets.UPDATE_S3_ENDPOINT }}
          VERSION: ${{ needs.check-stable.outputs.version }}
        run: |
          if [ -z "$S3_BUCKET" ]; then
            echo "âš ï¸ UPDATE_S3_BUCKET is not configured, skipping S3 upload"
            echo ""
            echo "To enable S3 upload, configure the following secrets:"
            echo "  - UPDATE_AWS_ACCESS_KEY_ID"
            echo "  - UPDATE_AWS_SECRET_ACCESS_KEY"
            echo "  - UPDATE_S3_BUCKET"
            echo "  - UPDATE_S3_REGION (optional, defaults to us-east-1)"
            echo "  - UPDATE_S3_ENDPOINT (optional, for S3-compatible services)"
            exit 0
          fi

          # æž„å»ºç«¯ç‚¹å‚æ•°
          ENDPOINT_ARG=""
          if [ -n "$S3_ENDPOINT" ]; then
            ENDPOINT_ARG="--endpoint-url $S3_ENDPOINT"
            echo "ðŸ“¡ Using custom S3 endpoint: $S3_ENDPOINT"
          fi

          echo "ðŸš€ Uploading to S3 bucket: $S3_BUCKET"
          echo "ðŸ“ Target path: s3://$S3_BUCKET/stable/"
          echo ""

          # 1. ä¸Šä¼ å®‰è£…åŒ…åˆ°ç‰ˆæœ¬ç›®å½•
          echo "ðŸ“¦ Uploading release files to s3://$S3_BUCKET/stable/$VERSION/"
          for file in release/*.dmg release/*.zip release/*.exe release/*.AppImage release/*.deb release/*.rpm release/*.snap release/*.tar.gz; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "   â†—ï¸ $filename"
              aws s3 cp "$file" "s3://$S3_BUCKET/stable/$VERSION/$filename" $ENDPOINT_ARG
            fi
          done

          # 2. åˆ›å»º stable*.yml (ä»Ž latest*.yml å¤åˆ¶ï¼Œå¹¶ä¿®æ”¹ URL åŠ ä¸Šç‰ˆæœ¬ç›®å½•å‰ç¼€)
          # electron-updater åœ¨ channel=stable æ—¶ä¼šæ‰¾ stable-mac.yml
          # S3 ç›®å½•ç»“æž„: stable/{version}/xxx.dmgï¼Œæ‰€ä»¥ URL éœ€è¦åŠ ä¸Š {version}/ å‰ç¼€
          echo ""
          echo "ðŸ“‹ Creating stable*.yml files from latest*.yml..."
          for yml in release/latest*.yml; do
            if [ -f "$yml" ]; then
              stable_name=$(basename "$yml" | sed 's/latest/stable/')
              # å¤åˆ¶å¹¶ä¿®æ”¹ URL: ç»™æ‰€æœ‰ url å­—æ®µåŠ ä¸Šç‰ˆæœ¬ç›®å½•å‰ç¼€
              # url: xxx.dmg -> url: {VERSION}/xxx.dmg
              sed "s|url: |url: $VERSION/|g" "$yml" > "release/$stable_name"
              echo "   ðŸ“„ Created $stable_name from $(basename $yml) with URL prefix: $VERSION/"
            fi
          done

          # 3. åˆ›å»º renderer manifest (ç”¨äºŽéªŒè¯ renderer tar å®Œæ•´æ€§)
          echo ""
          echo "ðŸ“‹ Creating renderer manifest..."
          RENDERER_TAR="release/lobehub-renderer.tar.gz"
          if [ -f "$RENDERER_TAR" ]; then
            RENDERER_SHA512=$(shasum -a 512 "$RENDERER_TAR" | awk '{print $1}' | xxd -r -p | base64)
            RENDERER_SIZE=$(stat -f%z "$RENDERER_TAR" 2>/dev/null || stat -c%s "$RENDERER_TAR")
            RELEASE_DATE=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
            echo "version: $VERSION" > "release/stable-renderer.yml"
            echo "files:" >> "release/stable-renderer.yml"
            echo "  - url: $VERSION/lobehub-renderer.tar.gz" >> "release/stable-renderer.yml"
            echo "    sha512: $RENDERER_SHA512" >> "release/stable-renderer.yml"
            echo "    size: $RENDERER_SIZE" >> "release/stable-renderer.yml"
            echo "path: $VERSION/lobehub-renderer.tar.gz" >> "release/stable-renderer.yml"
            echo "sha512: $RENDERER_SHA512" >> "release/stable-renderer.yml"
            echo "releaseDate: '$RELEASE_DATE'" >> "release/stable-renderer.yml"
            echo "   ðŸ“„ Created stable-renderer.yml with SHA512 checksum"
          else
            echo "   âš ï¸ Renderer tar not found, skipping manifest creation"
          fi

          # 4. ä¸Šä¼  manifest åˆ°æ ¹ç›®å½•å’Œç‰ˆæœ¬ç›®å½•
          # æ ¹ç›®å½•: electron-updater éœ€è¦ï¼Œä¼šè¢«æ¯æ¬¡å‘ç‰ˆè¦†ç›–
          # ç‰ˆæœ¬ç›®å½•: ä½œä¸ºå­˜æ¡£ä¿ç•™
          echo ""
          echo "ðŸ“‹ Uploading manifest files..."
          for yml in release/stable*.yml release/latest*.yml; do
            if [ -f "$yml" ]; then
              filename=$(basename "$yml")
              echo "   â†—ï¸ $filename -> s3://$S3_BUCKET/stable/$filename"
              aws s3 cp "$yml" "s3://$S3_BUCKET/stable/$filename" $ENDPOINT_ARG
              echo "   â†—ï¸ $filename -> s3://$S3_BUCKET/stable/$VERSION/$filename (archive)"
              aws s3 cp "$yml" "s3://$S3_BUCKET/stable/$VERSION/$filename" $ENDPOINT_ARG
            fi
          done

          echo ""
          echo "âœ… S3 upload completed!"
          echo ""
          echo "ðŸ“‹ Files in s3://$S3_BUCKET/stable/:"
          aws s3 ls "s3://$S3_BUCKET/stable/" $ENDPOINT_ARG || true
          echo ""
          echo "ðŸ“‹ Files in s3://$S3_BUCKET/stable/$VERSION/:"
          aws s3 ls "s3://$S3_BUCKET/stable/$VERSION/" $ENDPOINT_ARG || true
