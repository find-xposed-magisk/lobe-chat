name: Release Desktop Nightly

# ============================================
# Nightly è‡ªåŠ¨å‘ç‰ˆå·¥ä½œæµ
# ============================================
# è§¦å‘æ¡ä»¶:
#   1. å®šæ—¶: æ¯å¤© UTC+8 14:00 (UTC 06:00)
#   2. æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
#
# ç‰ˆæœ¬ç­–ç•¥:
#   åŸºäºæœ€æ–° tag çš„ minor+1, æ ¼å¼: X.(Y+1).0-nightly.YYYYMMDDHHMM
#   ä¾‹: å½“å‰ tag v2.0.12 â†’ v2.1.0-nightly.202502091400
#   ä½¿ç”¨ç²¾ç¡®åˆ°åˆ†é’Ÿçš„æ—¶é—´æˆ³é¿å…åŒä¸€å¤©å¤šæ¬¡è§¦å‘æ—¶ tag å†²çª
# ============================================

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      force:
        description: 'Force build (skip diff check)'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

permissions: read-all

env:
  NODE_VERSION: '24.11.1'

jobs:
  # ============================================
  # è®¡ç®— Nightly ç‰ˆæœ¬å·
  # ============================================
  calculate-version:
    name: Calculate Nightly Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      has_changes: ${{ steps.changes.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Check for code changes since last nightly
        id: changes
        run: |
          # æ‰‹åŠ¨è§¦å‘ + force æ—¶è·³è¿‡ diff æ£€æŸ¥
          if [ "${{ inputs.force }}" == "true" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ”§ Force build requested, skipping diff check"
            exit 0
          fi

          # æŸ¥æ‰¾ä¸Šä¸€ä¸ª nightly tag
          last_nightly=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+-nightly\.' | head -n 1)

          if [ -z "$last_nightly" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ No previous nightly tag found, proceeding with first nightly build"
            exit 0
          fi

          echo "ğŸ“Œ Last nightly tag: $last_nightly"

          # å¯¹æ¯”æŒ‡å®šç›®å½•æ˜¯å¦æœ‰å˜æ›´
          changes=$(git diff --name-only "$last_nightly"..HEAD -- package.json src/ packages/ apps/desktop/)

          if [ -z "$changes" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ No code changes since $last_nightly, skipping nightly build"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            change_count=$(echo "$changes" | wc -l | tr -d ' ')
            echo "âœ… ${change_count} file(s) changed since $last_nightly:"
            echo "$changes" | head -20
            [ "$change_count" -gt 20 ] && echo "  ... and $((change_count - 20)) more"
          fi

      - name: Calculate nightly version
        if: steps.changes.outputs.has_changes == 'true'
        id: version
        run: |
          # è·å–æœ€æ–°çš„ tag (æ’é™¤ nightly tag)
          latest_tag=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1)

          if [ -z "$latest_tag" ]; then
            echo "âŒ No stable tag found"
            exit 1
          fi

          echo "ğŸ“Œ Latest stable tag: $latest_tag"

          # å»æ‰ v å‰ç¼€
          base_version="${latest_tag#v}"

          # è§£æ major.minor.patch
          IFS='.' read -r major minor patch <<< "$base_version"

          # minor + 1, patch å½’é›¶
          new_minor=$((minor + 1))
          timestamp=$(date -u +"%Y%m%d%H%M")

          version="${major}.${new_minor}.0-nightly.${timestamp}"
          tag="v${version}"

          echo "version=${version}" >> $GITHUB_OUTPUT
          echo "tag=${tag}" >> $GITHUB_OUTPUT
          echo "âœ… Nightly version: ${version}"
          echo "ğŸ·ï¸ Tag: ${tag}"

  # ============================================
  # ä»£ç è´¨é‡æ£€æŸ¥
  # ============================================
  test:
    name: Code quality check
    needs: [calculate-version]
    if: needs.calculate-version.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          package-manager-cache: false

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install deps
        run: bun i

      - name: Lint
        run: bun run lint

  # ============================================
  # å¤šå¹³å°æ„å»º
  # ============================================
  build:
    needs: [calculate-version, test]
    if: needs.calculate-version.outputs.has_changes == 'true'
    name: Build Desktop App
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-15, macos-15-intel, windows-2025, ubuntu-latest]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup build environment
        uses: ./.github/actions/desktop-build-setup
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Set package version
        run: npm run workflow:set-desktop-version ${{ needs.calculate-version.outputs.version }} nightly

      # macOS æ„å»ºå‰æ¸…ç† (ä¿®å¤ hdiutil é—®é¢˜ https://github.com/electron-userland/electron-builder/issues/8415)
      - name: Clean previous build artifacts (macOS)
        if: runner.os == 'macOS'
        run: |
          sudo rm -rf apps/desktop/release || true
          sudo rm -rf apps/desktop/dist || true
          sudo rm -rf /tmp/electron-builder* || true

      # macOS æ„å»º
      - name: Build artifact on macOS
        if: runner.os == 'macOS'
        run: npm run desktop:package:app
        env:
          UPDATE_CHANNEL: nightly
          APP_URL: http://localhost:3015
          DATABASE_URL: 'postgresql://postgres@localhost:5432/postgres'
          KEY_VAULTS_SECRET: 'oLXWIiR/AKF+rWaqy9lHkrYgzpATbW3CtJp3UfkVgpE='
          CSC_LINK: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CSC_KEY_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          CSC_FOR_PULL_REQUEST: true
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          NEXT_PUBLIC_DESKTOP_PROJECT_ID: ${{ secrets.UMAMI_BETA_DESKTOP_PROJECT_ID }}
          NEXT_PUBLIC_DESKTOP_UMAMI_BASE_URL: ${{ secrets.UMAMI_BETA_DESKTOP_BASE_URL }}

      # Windows æ„å»º
      - name: Build artifact on Windows
        if: runner.os == 'Windows'
        run: npm run desktop:package:app
        env:
          UPDATE_CHANNEL: nightly
          APP_URL: http://localhost:3015
          DATABASE_URL: 'postgresql://postgres@localhost:5432/postgres'
          KEY_VAULTS_SECRET: 'oLXWIiR/AKF+rWaqy9lHkrYgzpATbW3CtJp3UfkVgpE='
          NEXT_PUBLIC_DESKTOP_PROJECT_ID: ${{ secrets.UMAMI_BETA_DESKTOP_PROJECT_ID }}
          NEXT_PUBLIC_DESKTOP_UMAMI_BASE_URL: ${{ secrets.UMAMI_BETA_DESKTOP_BASE_URL }}
          TEMP: C:\temp
          TMP: C:\temp

      # Linux æ„å»º
      - name: Build artifact on Linux
        if: runner.os == 'Linux'
        run: npm run desktop:package:app
        env:
          UPDATE_CHANNEL: nightly
          APP_URL: http://localhost:3015
          DATABASE_URL: 'postgresql://postgres@localhost:5432/postgres'
          KEY_VAULTS_SECRET: 'oLXWIiR/AKF+rWaqy9lHkrYgzpATbW3CtJp3UfkVgpE='
          NEXT_PUBLIC_DESKTOP_PROJECT_ID: ${{ secrets.UMAMI_BETA_DESKTOP_PROJECT_ID }}
          NEXT_PUBLIC_DESKTOP_UMAMI_BASE_URL: ${{ secrets.UMAMI_BETA_DESKTOP_BASE_URL }}

      - name: Upload artifacts
        uses: ./.github/actions/desktop-upload-artifacts
        with:
          artifact-name: release-${{ matrix.os }}
          retention-days: 3

  # ============================================
  # åˆå¹¶ macOS å¤šæ¶æ„ latest-mac.yml æ–‡ä»¶
  # ============================================
  merge-mac-files:
    needs: [build]
    name: Merge macOS Release Files
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          package-manager-cache: false

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: release
          pattern: release-*
          merge-multiple: true

      - name: List downloaded artifacts
        run: ls -R release

      - name: Install yaml only for merge step
        run: |
          cd scripts/electronWorkflow
          if [ ! -f package.json ]; then
            echo '{"name":"merge-mac-release","private":true}' > package.json
          fi
          bun add --no-save yaml@2.8.1

      - name: Merge latest-mac.yml files
        run: bun run scripts/electronWorkflow/mergeMacReleaseFiles.js

      - name: Upload artifacts with merged macOS files
        uses: actions/upload-artifact@v6
        with:
          name: merged-release
          path: release/
          retention-days: 1

  # ============================================
  # åˆ›å»º Nightly Release
  # ============================================
  publish-release:
    needs: [merge-mac-files, calculate-version]
    name: Publish Nightly Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download merged artifacts
        uses: actions/download-artifact@v7
        with:
          name: merged-release
          path: release

      - name: List final artifacts
        run: ls -R release

      - name: Create Nightly Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.calculate-version.outputs.tag }}
          name: 'Desktop Nightly ${{ needs.calculate-version.outputs.tag }}'
          prerelease: true
          body: |
            ## ğŸŒ™ Nightly Build â€” ${{ needs.calculate-version.outputs.tag }}

            > Automated nightly build from `main` branch.

            ### âš ï¸ Important Notes

            - **This is an automated nightly build and is NOT intended for production use.**
            - Nightly builds are generated from the latest `main` branch and may contain **unstable, untested, or incomplete features**.
            - **No guarantees** are made regarding stability, data integrity, or backward compatibility.
            - Bugs, crashes, and breaking changes are expected. **Use at your own risk.**
            - **Do NOT report bugs** from nightly builds unless you can reproduce them on the latest beta or stable release.
            - Nightly builds may have **different update channels** â€” they will not auto-update to/from stable or beta versions.
            - It is strongly recommended to **back up your data** before using a nightly build.

            ### ğŸ“¦ Installation

            Download the appropriate installer for your platform from the assets below.

            | Platform | File |
            |----------|------|
            | macOS (Apple Silicon) | `.dmg` (arm64) |
            | macOS (Intel) | `.dmg` (x64) |
            | Windows | `.exe` |
            | Linux | `.AppImage` / `.deb` |
          files: |
            release/latest*
            release/*.dmg*
            release/*.zip*
            release/*.exe*
            release/*.AppImage
            release/*.deb*
            release/*.snap*
            release/*.rpm*
            release/*.tar.gz*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # æ¸…ç†æ—§çš„ Nightly Releases (ä¿ç•™æœ€è¿‘ 7 ä¸ª)
  # ============================================
  cleanup-old-nightlies:
    needs: [publish-release]
    name: Cleanup Old Nightly Releases
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Delete old nightly releases
        uses: actions/github-script@v7
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
            });

            const nightlyReleases = releases
              .filter(r => r.tag_name.includes('-nightly.'))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            const toDelete = nightlyReleases.slice(7);

            for (const release of toDelete) {
              console.log(`ğŸ—‘ï¸ Deleting old nightly release: ${release.tag_name}`);

              // Delete the release
              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id,
              });

              // Delete the tag
              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `tags/${release.tag_name}`,
                });
              } catch (e) {
                console.log(`âš ï¸ Could not delete tag ${release.tag_name}: ${e.message}`);
              }
            }

            console.log(`âœ… Cleanup complete. Kept ${Math.min(nightlyReleases.length, 7)} nightly releases, deleted ${toDelete.length}.`);
